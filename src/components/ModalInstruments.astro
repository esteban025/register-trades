---
import { actions } from "astro:actions";
import ModalDesign from "./ModalDesign.astro";
---

<ModalDesign idModal="modal-instrument" titleModal="Nuevo Activo">
  <div class="" slot="body-modal">
    <form id="form-instrument" action={actions.createInstrument} class="form">
      <div class="container-contents">
        <div class="content-input">
          <input
            type="text"
            name="name-instrument"
            id="name-instrument"
            style="text-transform: uppercase;"
            placeholder=" "
            autocomplete="off"
          />
          <label for="name-instrument">Nombre del activo</label>
        </div>
        <div class="content-input">
          <!-- valor con decimales por ejemplo 0.01 -->
          <input
            type="number"
            name="value-instrument"
            id="value-instrument"
            step="0.01"
            placeholder=" "
          />
          <label for="value-instrument">Valor del activo</label>
        </div>
      </div>
      <div class="content-btns">
        <button
          type="reset"
          class="btn btn-secondary"
          data-close="modal-instrument">Cancelar</button
        >
        <button type="submit" class="btn btn-primary">Guardar</button>
      </div>
    </form>
  </div>
</ModalDesign>

<script>
  import { setupModalCloseHandlers } from "@/scripts/modalClose";
  import { isModalInstrumentOpen, showNotification } from "@/store";
  import { $id } from "@/utils/getElementsDom";
  import { actions } from "astro:actions";

  document.addEventListener("DOMContentLoaded", () => {
    const modalInstrument = $id("modal-instrument");
    const form = $id("form-instrument") as HTMLFormElement;

    isModalInstrumentOpen.subscribe((isOpen) => {
      if (isOpen) {
        modalInstrument?.classList.add("is-active");
        modalInstrument?.classList.remove("hidden");
      } else {
        closeModalInstrument();
      }
    });

    function closeModalInstrument() {
      form.reset();
      modalInstrument?.classList.remove("is-active");
      modalInstrument?.classList.add("hidden");
      isModalInstrumentOpen.set(false);
    }

    // datos de formulario
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const name = (formData.get("name-instrument") as string).toUpperCase();
      const pip_value = parseFloat(formData.get("value-instrument") as string);

      if (!name || isNaN(pip_value)) {
        showNotification(
          "Por favor completa todos los campos correctamente",
          "error",
        );
        return;
      }

      try {
        const { data, error } = await actions.createInstrument({
          name,
          pip_value,
        });

        if (error || !data.success) {
          showNotification(
            error?.message || data?.message || "Error al crear el activo",
            "error",
          );
        } else {
          showNotification(
            data.message || "Activo creado exitosamente",
            "success",
          );
          closeModalInstrument();
        }
      } catch (err) {
        showNotification("Error inesperado al crear el activo", "error");
        console.error(err);
      }
    });

    setupModalCloseHandlers("modal-instrument", closeModalInstrument);
  });
</script>
